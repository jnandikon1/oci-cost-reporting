# Copilot Instructions for OCI Infrastructure Reporting

## Project Overview
This is an Oracle Cloud Infrastructure (OCI) inventory and reporting tool that discovers and documents ADB (Autonomous Database) and non-ADB infrastructure resources across an OCI tenancy. The workflow follows a **three-stage pipeline**:

1. **Inventory Collection** - Python scripts querying OCI API
2. **Data Persistence** - Loading CSV data to Oracle Autonomous Data Warehouse (ADW)
3. **Reporting & Visualization** - Excel exports + APEX dashboard generation with cost estimates

This integration supports **scheduled daily runs** via cron jobs and **email delivery** of reports through OCI Email Delivery service.

## Architecture & Data Flow

### Core Workflow
1. **Inventory Collection Phase** (`scripts/*_inventory.py`)
   - Query OCI API using `oci` SDK to discover resources across all compartments
   - Use profile-based authentication: `oci.config.from_file(profile_name=PROFILE)`
   - Pagination with `oci.pagination.list_call_get_all_results()` for large result sets
   - Export raw data as CSV to `data/` directory with ISO timestamp: `adb_inventory_YYYYMMDD_HHMMSS.csv`

2. **Database Persistence Phase** (`scripts/database_loader.py`)
   - Load latest CSV files to Oracle Autonomous Data Warehouse (ADW)
   - Creates/manages two tables: `OCI_ADB_INVENTORY` and `OCI_NON_ADB_INVENTORY`
   - Supports password retrieval from OCI Vault Secret for production security
   - Implements row-level error handling (skip bad rows, continue loading)
   - Uses `cx_Oracle` with wallet-based authentication

3. **Report Generation Phase** (`scripts/*_inventory_to_excel.py`)
   - Read **latest CSV** from `data/` using glob sorting
   - Transform data with pandas (add calculated cost columns)
   - Write multi-sheet Excel reports to `reports/` directory
   - Apply formatting (headers, filters, column widths) using `xlsxwriter` engine

4. **Scheduling & Email Phase** (`shell_scripts/run_daily_report.sh`)
   - Orchestrates full pipeline execution
   - Manages cron job scheduling (configurable frequency)
   - Sends email notifications with report attachments via postfix + OCI Email Delivery
   - Automatic cleanup of reports older than REPORT_DAYS_TO_KEEP (default: 30)

### Resource Types
- **ADB (Autonomous Database)**: `adb_client.list_autonomous_databases()` - tracks CPU, storage, auto-scaling, license model
- **Non-ADB Infrastructure**: `db_client.list_vm_clusters()` - tracks VM clusters, CPU cores

### Key Pattern: Compartment Iteration
Both inventory scripts filter for `ACTIVE` lifecycle state and skip on OCI API exceptions:
```python
for comp in compartments:
    if comp.lifecycle_state != "ACTIVE":
        continue
    try:
        # Query resources within compartment
    except Exception:
        continue  # Skip compartments user lacks access to
```

## Configuration & Secrets
- **OCI Credentials**: Uses `OCI_PROFILE` environment variable (defaults to "DEFAULT")
- **Config File Location**: `~/.oci/config` (standard OCI SDK behavior)
- **ADW Wallet**: Download from OCI Console (Database > Database Connection > Download Client Credential) → extract to `~/ADWCUSG`
- **ADW Password**: Retrieve from OCI Vault Secret (recommended) or environment variable `ADW_PASSWORD`
- **Email Configuration**: Postfix + OCI Email Delivery; configured via `.env.apex`
- **Cost Estimates**: Hardcoded in Excel scripts (OCPU_COST_PER_MONTH, STORAGE_COST_PER_TB) - update manually if rates change

## Directory Structure
- `scripts/` - Five Python modules:
  - `adb_inventory.py` - Collect ADB resources
  - `non_adb_infra_inventory.py` - Collect VM clusters
  - `database_loader.py` - Load CSVs to ADW (NEW)
  - `adb_inventory_to_excel.py` - Generate ADB reports
  - `non_adb_inventory_to_excel.py` - Generate Non-ADB reports
- `shell_scripts/` - Orchestration and setup (NEW):
  - `run_daily_report.sh` - Master scheduler script
  - `setup_apex_integration.sh` - Interactive setup wizard
- `data/` - Timestamped CSV outputs (created automatically)
- `reports/` - Timestamped Excel reports (created automatically)
- `logs/` - Execution logs from cron jobs (NEW)
- `.env.apex` - Environment configuration (generated by setup, add to .gitignore)
- `ansible/` - Playbooks/roles for infrastructure deployment (not actively used in current scripts)

## Critical Integration Points: Apex Workflow

### Setup & Deployment
1. **Run interactive setup**: `bash shell_scripts/setup_apex_integration.sh`
   - Validates OCI credentials, ADW wallet, Python dependencies
   - Configures email (postfix + OCI Email Delivery)
   - Creates `.env.apex` with all environment variables
   - Sets up crontab for scheduled runs
   
2. **ADW Prerequisites**:
   - Download and extract wallet to `~/ADWCUSG`
   - Ensure `USAGE` user is unlocked (SQL: `ALTER USER USAGE ACCOUNT UNLOCK`)
   - Store password in OCI Vault Secret (via `OCI -> Security -> Vault -> Secrets`)
   - Grant minimal permissions to USAGE user for table creation

3. **Email Configuration** (optional):
   - Create OCI Email Delivery approved sender (OCI Console > Email Delivery)
   - Generate SMTP credentials for IAM user (bottom-left menu in Users)
   - Setup postfix relay to OCI SMTP endpoint (e.g., `smtp.us-ashburn-1.oraclecloud.com:587`)
   - Test with: `echo "test" | mail -s "Test" recipient@domain.com`

### APEX Dashboard Creation
After tables are populated (`OCI_ADB_INVENTORY`, `OCI_NON_ADB_INVENTORY`):
1. Login to APEX workspace (OCI Console > ADW > Service Console > Oracle APEX)
2. Create Interactive Reports based on inventory tables
3. Add dashboard charts: CPU distribution, storage trends, compartment breakdown
4. Configure APEX email subscriptions for automated delivery
5. Reference sample queries in Section 13 of usage-reports-to-adw documentation

## Common Development Tasks

### Scheduling Daily Reports (Apex Integration)
```bash
# 1. Initial setup (interactive, creates .env.apex)
bash shell_scripts/setup_apex_integration.sh

# 2. Test full pipeline manually
source .env.apex
bash shell_scripts/run_daily_report.sh

# 3. View crontab entry
crontab -l | grep run_daily_report.sh

# 4. Monitor execution logs
tail -f logs/run_daily_report_*.log
```

### Adding Database Loader to Existing Cron
If you already have a cron job without ADW integration:
```bash
# Edit existing run_daily_report.sh to source .env.apex and call database_loader.py
# After inventory collection (step 2), add:
python3 scripts/database_loader.py  # Loads CSVs to ADW
# Before Excel generation
```

### Adding a New Resource Type with ADW Persistence
1. Create inventory script (e.g., `new_resource_inventory.py`) → CSV in `data/`
2. Add table creation method in `database_loader.py`:
   ```python
   def create_new_resource_table(self):
       query = "CREATE TABLE IF NOT EXISTS OCI_NEW_RESOURCE (...)"
   ```
3. Add load method:
   ```python
   def load_new_resource_inventory(self, csv_file: Path) -> int:
       # Load CSV rows to table
   ```
4. Call in `load_latest_inventories()` main function
5. Create corresponding Excel generator
6. Add to `run_daily_report.sh` step 4

### Updating Cost Estimates
- Edit hardcoded constants in Excel scripts (e.g., `OCPU_COST_PER_MONTH = 65`)
- Re-run Excel script to regenerate reports with new calculations
- OR update in APEX as computed columns: `CPU_COUNT * 65 AS ESTIMATED_COST`

### Debugging OCI Connectivity
- Verify OCI config: `echo $OCI_PROFILE` and check `~/.oci/config`
- Check compartment access: scripts silently skip inaccessible compartments
- Enable verbose output by adding print statements before `try` blocks
- For ADW: Test with `sqlplus usage@ADWCUSG_low` (requires wallet)

### Debugging Email Delivery
```bash
# Test postfix configuration
echo "Test message" | mail -s "Test" recipient@domain.com

# Check postfix logs
sudo journalctl -u postfix -n 50 -f

# Verify SMTP credentials
cat /etc/postfix/sasl_passwd  # Should contain smtp.region:587 user:pass

# Test with verbose output
MAIL_FROM="sender@domain.com" mail -v -s "Test" recipient@domain.com < /dev/null
```

## Dependencies & Versions
- **oci**: OCI Python SDK (handles API calls, pagination, authentication)
- **pandas**: Data transformation and CSV reading
- **cx_Oracle**: Oracle database connectivity (ADW integration)
- **openpyxl**, **xlsxwriter**: Excel file generation and formatting
- **jinja2**: Templating (currently unused, reserved for future reports)
- **tabulate**: Display utilities (currently unused)

**System Dependencies** (for Apex integration):
- Oracle Instant Client 19.x+ (for cx_Oracle and sqlplus)
- Postfix (for email delivery)
- SQLPlus (for database testing/admin tasks)

Python 3.6+

## Testing & Validation
- No automated tests currently in repo
- Validate inventory scripts by checking `data/` for timestamped CSV files with expected columns
- Validate Excel scripts by checking `reports/` for generated `.xlsx` files
- Manual integration test: Run `adb_inventory.py` → `adb_inventory_to_excel.py` → inspect Excel output

## Important Edge Cases
- Scripts are resilient to partial OCI API failures per compartment
- Empty resource lists (no ADB/VM clusters in compartment) don't generate CSV rows
- Excel reports use **latest CSV only** - old CSVs are preserved but not used
- Cost calculations may be null if source data is missing (use `fillna(0)` pattern in pandas)
