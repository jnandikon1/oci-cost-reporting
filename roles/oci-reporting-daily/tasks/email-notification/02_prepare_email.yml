---
# Prepare email body from template and gather report files for attachment

- name: Create email template directory if missing
  file:
    path: "{{ role_path }}/templates"
    state: directory
    mode: '0755'
  tags:
    - email-notification
    - prepare-email

- name: Generate email body from template
  template:
    src: "{{ role_path }}/templates/email_body.txt.j2"
    dest: "/tmp/email_body_{{ execution_timestamp }}.txt"
  register: email_body_generated
  vars:
    adb_inventory_file: "{{ adb_report_file | basename }}"
    non_adb_inventory_file: "{{ non_adb_report_file | basename }}"
    execution_date: "{{ ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%S%z') | strftime('%Y-%m-%d %H:%M:%S') }}"
  tags:
    - email-notification
    - prepare-email

- name: Read email body content
  slurp:
    src: "{{ email_body_generated.dest }}"
  register: email_body_content
  tags:
    - email-notification
    - prepare-email

- name: Set email body in facts
  set_fact:
    email_message_body: "{{ email_body_content.content | b64decode }}"
  tags:
    - email-notification
    - prepare-email

- name: Collect report files for attachment
  find:
    paths: "{{ reports_dir }}"
    patterns: "*_report_*.xlsx"
    file_type: file
    age: "-1h"
  register: report_attachments
  tags:
    - email-notification
    - prepare-email

- name: Build attachment list
  set_fact:
    email_attachments: "{{ report_attachments.files | map(attribute='path') | list }}"
    attachment_count: "{{ report_attachments.files | length }}"
  tags:
    - email-notification
    - prepare-email

- name: Display email preparation status
  debug:
    msg: |
      âœ“ Email Preparation Complete:
        Subject: {{ email_subject }}
        Body File: {{ email_body_generated.dest }}
        Body Size: {{ (email_message_body | length) }} characters
        Recipients: {{ email_recipients | length }}
        Attachments: {{ attachment_count }}
      {% for attachment in email_attachments %}
          - {{ attachment | basename }}
      {% endfor %}
  tags:
    - email-notification
    - prepare-email
