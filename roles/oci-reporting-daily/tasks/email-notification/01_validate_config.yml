---
# Validate email configuration and notification prerequisites

- name: Check email delivery configuration
  assert:
    that:
      - email_enabled | bool
      - email_from | length > 0
      - email_recipients | length > 0
    fail_msg: |
      Email configuration missing:
        Email Enabled: {{ email_enabled }}
        From Address: {{ email_from }}
        Recipients: {{ email_recipients }}
    success_msg: "✓ Email configuration validated"
  tags:
    - email-notification
    - validate

- name: Check mail command availability
  shell: which mail
  register: mail_check
  changed_when: false
  tags:
    - email-notification
    - validate

- name: Assert mail utility is available
  assert:
    that:
      - mail_check.rc == 0
    fail_msg: "mail utility not found. Install mailutils or postfix."
    success_msg: "✓ Mail utility available at {{ mail_check.stdout | trim }}"
  tags:
    - email-notification
    - validate

- name: Validate SMTP configuration (if using OCI Email Delivery)
  assert:
    that:
      - smtp_host | length > 0 or not use_oci_email_delivery | bool
      - smtp_port | int > 0 or not use_oci_email_delivery | bool
    fail_msg: "SMTP configuration incomplete for OCI Email Delivery"
    success_msg: "✓ SMTP configuration validated"
  tags:
    - email-notification
    - validate

- name: Validate report files exist
  stat:
    path: "{{ item }}"
  register: report_stat
  loop:
    - "{{ adb_report_file }}"
    - "{{ non_adb_report_file }}"
  tags:
    - email-notification
    - validate

- name: Assert reports exist for email attachment
  assert:
    that:
      - report_stat.results | map(attribute='stat.exists') | list | all
    fail_msg: "Report files not found for email attachment"
    success_msg: "✓ Report files exist and ready for email"
  tags:
    - email-notification
    - validate

- name: Display email validation results
  debug:
    msg: |
      ✓ Email Configuration Validated:
        From: {{ email_from }}
        Recipients: {{ email_recipients | join(', ') }}
        Subject: {{ email_subject }}
        Attachments: {{ report_stat.results | length }}
        Mail Command: {{ mail_check.stdout | trim }}
        SMTP Host: {{ smtp_host | default('local') }}
  tags:
    - email-notification
    - validate
