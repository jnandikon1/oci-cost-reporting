---
# Verify email was sent and delivery status

- name: Check postfix mail queue
  shell: mailq | tail -5
  register: mail_queue
  changed_when: false
  tags:
    - email-notification
    - verify-delivery

- name: Check system mail logs for delivery confirmation
  shell: |
    grep -i "status=sent\|Successfully sent" /var/log/mail.log /var/log/syslog 2>/dev/null | tail -5
  register: mail_logs
  changed_when: false
  failed_when: false
  tags:
    - email-notification
    - verify-delivery

- name: Display mail queue status
  debug:
    msg: |
      ✓ Email Delivery Verification:
        Mail Queue Status:
        {{ mail_queue.stdout | default('No pending messages') }}
        
        Recent Mail Log Entries:
        {{ mail_logs.stdout | default('No log entries found') }}
  when: mail_queue.stdout | length > 0 or mail_logs.stdout | length > 0
  tags:
    - email-notification
    - verify-delivery

- name: Set email send completion status
  set_fact:
    email_send_status: "SUCCESS"
    email_send_timestamp: "{{ ansible_date_time.iso8601 }}"
    recipients_count: "{{ email_recipients | length }}"
  tags:
    - email-notification
    - verify-delivery

- name: Display final email notification summary
  debug:
    msg: |
      ✓ Email Notification - COMPLETED:
        Status: {{ email_send_status }}
        Subject: {{ email_subject }}
        From: {{ email_from }}
        Recipients: {{ recipients_count }}
          {% for recipient in email_recipients %}
          - {{ recipient }}
          {% endfor %}
        Attachments: {{ attachment_count }}
        Timestamp: {{ email_send_timestamp }}
  tags:
    - email-notification
    - verify-delivery
