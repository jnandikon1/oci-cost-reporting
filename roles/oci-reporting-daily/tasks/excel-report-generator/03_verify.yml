---
# Verify generated Excel reports are valid and contain data

- name: Find generated ADB Excel reports
  find:
    paths: "{{ reports_dir }}"
    patterns: "adb_inventory_report_*.xlsx"
    file_type: file
  register: adb_reports
  tags:
    - generate-reports
    - verify-reports

- name: Find generated Non-ADB Excel reports
  find:
    paths: "{{ reports_dir }}"
    patterns: "non_adb_inventory_report_*.xlsx"
    file_type: file
  register: non_adb_reports
  tags:
    - generate-reports
    - verify-reports

- name: Assert Excel reports exist
  assert:
    that:
      - adb_reports.files | length > 0
      - non_adb_reports.files | length > 0
    fail_msg: "Generated Excel reports not found in {{ reports_dir }}"
    success_msg: "✓ Excel reports verified"
  tags:
    - generate-reports
    - verify-reports

- name: Get latest ADB Excel report stats
  stat:
    path: "{{ (adb_reports.files | sort(attribute='mtime', reverse=True) | first).path }}"
  register: adb_report_stat
  tags:
    - generate-reports
    - verify-reports

- name: Get latest Non-ADB Excel report stats
  stat:
    path: "{{ (non_adb_reports.files | sort(attribute='mtime', reverse=True) | first).path }}"
  register: non_adb_report_stat
  tags:
    - generate-reports
    - verify-reports

- name: Assert Excel files are not empty
  assert:
    that:
      - adb_report_stat.stat.size > 1000
      - non_adb_report_stat.stat.size > 1000
    fail_msg: |
      Excel reports appear to be invalid or empty:
        ADB Report Size: {{ adb_report_stat.stat.size }} bytes
        Non-ADB Report Size: {{ non_adb_report_stat.stat.size }} bytes
    success_msg: "✓ Excel files validated (non-empty)"
  tags:
    - generate-reports
    - verify-reports

- name: Set generated report paths in facts
  set_fact:
    adb_report_file: "{{ adb_report_stat.stat.path }}"
    non_adb_report_file: "{{ non_adb_report_stat.stat.path }}"
    report_file_count: 2
  tags:
    - generate-reports
    - verify-reports

- name: Display report verification results
  debug:
    msg: |
      ✓ Excel Report Verification:
        
        ADB Inventory Report:
          File: {{ adb_report_stat.stat.path | basename }}
          Size: {{ (adb_report_stat.stat.size / 1024) | int }} KB
          Modified: {{ adb_report_stat.stat.mtime | timestamp_now }}
          Status: VERIFIED
        
        Non-ADB Inventory Report:
          File: {{ non_adb_report_stat.stat.path | basename }}
          Size: {{ (non_adb_report_stat.stat.size / 1024) | int }} KB
          Modified: {{ non_adb_report_stat.stat.mtime | timestamp_now }}
          Status: VERIFIED
        
        Total Reports: {{ report_file_count }}
        Location: {{ reports_dir }}
  tags:
    - generate-reports
    - verify-reports
