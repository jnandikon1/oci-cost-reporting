---
# Find the latest ADB and Non-ADB CSV files for report generation

- name: Find latest ADB inventory CSV
  find:
    paths: "{{ data_dir }}"
    patterns: "adb_inventory_*.csv"
    file_type: file
  register: adb_csv_search
  tags:
    - generate-reports
    - find-files

- name: Find latest Non-ADB inventory CSV
  find:
    paths: "{{ data_dir }}"
    patterns: "non_adb_infra_inventory_*.csv"
    file_type: file
  register: non_adb_csv_search
  tags:
    - generate-reports
    - find-files

- name: Assert CSV files exist
  assert:
    that:
      - adb_csv_search.files | length > 0
      - non_adb_csv_search.files | length > 0
    fail_msg: "CSV inventory files not found in {{ data_dir }}"
    success_msg: "✓ CSV files found - ready for report generation"
  tags:
    - generate-reports
    - find-files

- name: Get latest ADB CSV file
  set_fact:
    adb_csv_file: "{{ (adb_csv_search.files | sort(attribute='mtime', reverse=True) | first).path }}"
    adb_csv_mtime: "{{ (adb_csv_search.files | sort(attribute='mtime', reverse=True) | first).mtime }}"
  tags:
    - generate-reports
    - find-files

- name: Get latest Non-ADB CSV file
  set_fact:
    non_adb_csv_file: "{{ (non_adb_csv_search.files | sort(attribute='mtime', reverse=True) | first).path }}"
    non_adb_csv_mtime: "{{ (non_adb_csv_search.files | sort(attribute='mtime', reverse=True) | first).mtime }}"
  tags:
    - generate-reports
    - find-files

- name: Display found CSV files
  debug:
    msg: |
      ✓ CSV Files Located:
        ADB CSV: {{ adb_csv_file | basename }}
          Modified: {{ (adb_csv_mtime | int) | timestamp_now }}
          Size: {{ ((adb_csv_search.files | first).size / 1024) | int }} KB
        
        Non-ADB CSV: {{ non_adb_csv_file | basename }}
          Modified: {{ (non_adb_csv_mtime | int) | timestamp_now }}
          Size: {{ ((non_adb_csv_search.files | first).size / 1024) | int }} KB
  tags:
    - generate-reports
    - find-files
