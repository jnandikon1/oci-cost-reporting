---
# Verify ADW tables were created and data loaded successfully

- name: Query ADB inventory table row count
  shell: |
    sqlplus -s "{{ adw_user }}/{{ adw_password }}@{{ adw_connection_string }}" <<EOF
    SET HEADING OFF FEEDBACK OFF PAGESIZE 0 LINESIZE 32767 ECHO OFF VERIFY OFF TRIMSPOOL ON
    SELECT COUNT(*) FROM OCI_ADB_INVENTORY;
    EXIT;
    EOF
  register: adb_table_count
  environment:
    TNS_ADMIN: "{{ adw_wallet_path }}"
  changed_when: false
  tags:
    - load-database
    - verify-load

- name: Query Non-ADB inventory table row count
  shell: |
    sqlplus -s "{{ adw_user }}/{{ adw_password }}@{{ adw_connection_string }}" <<EOF
    SET HEADING OFF FEEDBACK OFF PAGESIZE 0 LINESIZE 32767 ECHO OFF VERIFY OFF TRIMSPOOL ON
    SELECT COUNT(*) FROM OCI_NON_ADB_INVENTORY;
    EXIT;
    EOF
  register: non_adb_table_count
  environment:
    TNS_ADMIN: "{{ adw_wallet_path }}"
  changed_when: false
  tags:
    - load-database
    - verify-load

- name: Parse table row counts
  set_fact:
    adb_row_count: "{{ adb_table_count.stdout | trim | int }}"
    non_adb_row_count: "{{ non_adb_table_count.stdout | trim | int }}"
  tags:
    - load-database
    - verify-load

- name: Assert tables contain data
  assert:
    that:
      - adb_row_count | int > 0
      - non_adb_row_count | int > 0
    fail_msg: |
      Data load verification failed:
        ADB Inventory Rows: {{ adb_row_count }}
        Non-ADB Inventory Rows: {{ non_adb_row_count }}
    success_msg: |
      ✓ Data load verification successful
        ADB Inventory Rows: {{ adb_row_count }}
        Non-ADB Inventory Rows: {{ non_adb_row_count }}
  tags:
    - load-database
    - verify-load

- name: Query table schemas
  shell: |
    sqlplus -s "{{ adw_user }}/{{ adw_password }}@{{ adw_connection_string }}" <<EOF
    SET HEADING OFF FEEDBACK OFF PAGESIZE 0 LINESIZE 32767 ECHO OFF VERIFY OFF TRIMSPOOL ON
    SELECT COLUMN_NAME FROM DBA_TAB_COLUMNS WHERE TABLE_NAME='OCI_ADB_INVENTORY' ORDER BY COLUMN_ID;
    EXIT;
    EOF
  register: adb_columns
  environment:
    TNS_ADMIN: "{{ adw_wallet_path }}"
  changed_when: false
  tags:
    - load-database
    - verify-load

- name: Display verification results
  debug:
    msg: |
      ✓ ADW Tables Verified:
        
        OCI_ADB_INVENTORY:
          Rows: {{ adb_row_count }}
          Columns: {{ adb_columns.stdout_lines | length }}
          Status: VERIFIED
        
        OCI_NON_ADB_INVENTORY:
          Rows: {{ non_adb_row_count }}
          Status: VERIFIED
        
        Verification Timestamp: {{ ansible_date_time.iso8601 }}
  tags:
    - load-database
    - verify-load

- name: Set load completion status
  set_fact:
    adw_load_status: "SUCCESS"
    adw_load_timestamp: "{{ ansible_date_time.iso8601 }}"
    table_row_counts:
      adb_inventory: "{{ adb_row_count }}"
      non_adb_inventory: "{{ non_adb_row_count }}"
  tags:
    - load-database
    - verify-load
