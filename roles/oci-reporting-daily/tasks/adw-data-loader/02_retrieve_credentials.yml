---
# Retrieve ADW password from environment variable or OCI Vault Secret

- name: Check if ADW password is in environment
  set_fact:
    adw_password_source: "environment"
  when: adw_password | length > 0
  tags:
    - load-database
    - retrieve-credentials

- name: Retrieve ADW password from OCI Vault (if not in environment)
  block:
    - name: Get secret from OCI Vault
      shell: |
        oci secrets secret-bundle get \
          --secret-id {{ adw_vault_secret_id }} \
          --profile {{ oci_profile }} \
          --query 'data."secret-bundle-content".content' \
          --raw-output | base64 -d
      register: vault_secret_result
      environment:
        OCI_PROFILE: "{{ oci_profile }}"
      changed_when: false
      tags:
        - load-database
        - retrieve-credentials

    - name: Set ADW password from vault
      set_fact:
        adw_password: "{{ vault_secret_result.stdout | trim }}"
        adw_password_source: "vault"
      tags:
        - load-database
        - retrieve-credentials
  when: 
    - adw_use_vault | bool
    - adw_password | length == 0
  tags:
    - load-database
    - retrieve-credentials

- name: Assert ADW password is available
  assert:
    that:
      - adw_password | length > 0
    fail_msg: "ADW password not found. Set ADW_PASSWORD env variable or configure vault access."
    success_msg: "✓ ADW credentials retrieved from {{ adw_password_source }}"
  tags:
    - load-database
    - retrieve-credentials

- name: Validate database connectivity (optional test)
  shell: |
    sqlplus -v
  register: sqlplus_check
  changed_when: false
  failed_when: sqlplus_check.rc != 0
  when: test_adw_connection | bool
  tags:
    - load-database
    - retrieve-credentials

- name: Display credentials status
  debug:
    msg: |
      ✓ Credentials Retrieved:
        Source: {{ adw_password_source }}
        User: {{ adw_user }}
        Connection String: {{ adw_connection_string }}
        SQLPlus Available: {{ sqlplus_check.rc == 0 | default('Not tested') }}
  tags:
    - load-database
    - retrieve-credentials
