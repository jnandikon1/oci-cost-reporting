---
# Centralize all facts and variables for oci-inventory-collection stage

- name: Set collection status - initialized
  set_fact:
    inventory_collection_status: "IN_PROGRESS"
    collection_start_timestamp: "{{ ansible_date_time.iso8601 }}"
  tags:
    - collect-inventory

- name: Set initial CSV paths
  set_fact:
    adb_csv_file: ""
    non_adb_csv_file: ""
    csv_file_count: 0
  tags:
    - collect-inventory

- name: Find latest CSV files for facts
  find:
    paths: "{{ data_dir }}"
    patterns: "{{ item.pattern }}"
    file_type: file
  register: csv_files
  loop:
    - { pattern: "{{ adb_csv_pattern }}", name: "adb" }
    - { pattern: "{{ non_adb_csv_pattern }}", name: "non_adb" }
  when: collect_adb_inventory or collect_non_adb_inventory
  tags:
    - collect-inventory

- name: Set ADB CSV path in facts
  set_fact:
    adb_csv_file: "{{ (csv_files.results[0].files | sort(attribute='mtime', reverse=True) | first).path }}"
    adb_csv_mtime: "{{ (csv_files.results[0].files | sort(attribute='mtime', reverse=True) | first).mtime }}"
  when: csv_files.results[0].files | length > 0
  tags:
    - collect-inventory

- name: Set Non-ADB CSV path in facts
  set_fact:
    non_adb_csv_file: "{{ (csv_files.results[1].files | sort(attribute='mtime', reverse=True) | first).path }}"
    non_adb_csv_mtime: "{{ (csv_files.results[1].files | sort(attribute='mtime', reverse=True) | first).mtime }}"
  when: csv_files.results[1].files | length > 0
  tags:
    - collect-inventory

- name: Count CSV files created
  set_fact:
    csv_file_count: "{{ (csv_files.results | map(attribute='files') | flatten | length) }}"
  tags:
    - collect-inventory

- name: Set collection completion status - success
  set_fact:
    inventory_collection_status: "SUCCESS"
    collection_end_timestamp: "{{ ansible_date_time.iso8601 }}"
  tags:
    - collect-inventory

- name: Display collected facts
  debug:
    msg: |
      âœ“ Inventory Collection Facts:
        Status: {{ inventory_collection_status }}
        ADB CSV: {{ adb_csv_file }}
        Non-ADB CSV: {{ non_adb_csv_file }}
        Total Files: {{ csv_file_count }}
        Start: {{ collection_start_timestamp }}
        End: {{ collection_end_timestamp }}
  tags:
    - collect-inventory
